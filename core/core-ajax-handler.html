<link rel="import" href="../bower_components/polymer/polymer.html">
<polymer-element name="core-ajax-handler">
  <template></template>
  <script>
    (function() {
      var base = '/';
      function defaultAjaxErrorHandler(xhr, err, desc) {
        console.log(xhr);
        var errorToast = document.querySelector('#errorToast');
        errorToast.text = '[' +xhr.status + '] ' + desc + ': ' + xhr.responseText.split(':')[1];
        errorToast.show();
      }

      function showMsg(msg) {
        var toast = document.querySelector('#errorToast');
        toast.text = msg;
        toast.show();
      }
      function createArticle(item) {
        var section = document.createElement('core-artc');
        section.setAttribute('layout', '');
        section.setAttribute('vertical', '');
        section.setAttribute('htitle', item.title);
        section.setAttribute('content', item.content);
        section.setAttribute('date', item.date);
        section.setAttribute('bgimg', item.bgimg);
        section.setAttribute('owner', item.iduser);
        section.setAttribute('idart', item._id);
        section.setAttribute('coments', item.coments);


        var div = document.createElement('core-card');
        div.setAttribute('userid','list');
        div.setAttribute('layout', '');
        div.setAttribute('vertical', '');

        div.appendChild(section);

        return div;
      }


      function doAjax(options, success, error) {
        options.type = options.type || 'GET';
        options.url = base + (options.url || '');
        options.dataType = options.dataType || 'json';
        options.contentType = options.contentType || 'application/json; charset=UTF-8';
        options.success = success;
        options.error = (typeof error === 'function') ? error : defaultAjaxErrorHandler;
        $.ajax(options);
      }

      function refresh() {
        doAjax({
          type: 'GET',
          url: 'routes_article/articles/0',
        },function(result) {
          static.articles = result;
          addListeners(static);
        });
      }

      function addListeners(static) {
          window.addEventListener('focus', function() {
            //refresh();
          });

          socket.on('err', function(msg) {
            showMsg(msg);
          });
          //cuando se crea un score lo que hace es lanzar esta funcion y recogerla
          socket.on('articleCreated', function(result) {
            // Get a reference to the element in which we want to insert a new node
            var parentElement = document.getElementsByTagName('wall-page')[0].$.list;
            // Get a reference to the first child
            var theFirstChild = parentElement.firstChild;

            // Create a new element
            var newElement = createArticle(result[0]);

            // Insert the new element before the first child
            parentElement.insertBefore(newElement, theFirstChild);

            showMsg('A new article has been added');
          });

          socket.on('userconnected', function(result) {
            document.getElementsByTagName("wall-page")[0].$.notifi.$.notifi.style.color="green";
            document.getElementsByTagName("wall-page")[0].$.notifi.$.notifi.icon = "social:notifications-on";
            showMsg('A new user has been registered!');
            debugger
          });

          // socket.on('scoreDestroyed', function(scoreId) {
          // 	for (var i = 0; i < static.scores.length; i++) {
          // 		if (scoreId === static.scores[i]._id) {
          // 			static.scores.splice(i, 1);
          // 			showMsg('Score [' + scoreId + '] destroyed');
          // 		}
          // 	}
          // });
          //
          // socket.on('scoreSetted', function(score) {
          // 	for (var i = 0; i < static.scores.length; i++) {
          // 		if (score._id === static.scores[i]._id) {
          // 			static.scores[i].home = score.home;
          // 			static.scores[i].guest = score.guest;
          // 		}
          // 	}
          // });
      }

      var static = {
        articles: null
      };

      refresh();
      Polymer('core-ajax-handler', {
        get : function(mail, password){
          var data={
            mail:mail,
            password: password
          };
          doAjax({
            type: 'GET',
            url: 'routes_user/validateuser',
            data: data
          },function(result) {
            document.getElementById('user').data(result);
            window.location.hash="/wall/?id="+result[0]._id;
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = xhr.responseText.split(':')[1];
            errorToast.show();
          });
        },
        create : function(datos){
          doAjax({
            type: 'POST',
            url: 'routes_user/user',
            data: datos
          },function(result) {
            document.getElementById('user').data(result);
            window.location.hash="/profile/?id="+result[0]._id;
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = xhr.responseText.split(':')[1];
            errorToast.show();
          });
        },
        sendArticle : function(datos){
          doAjax({
            type: 'POST',
            url: 'routes_article/article',
            data: datos
          },function(result) {
            window.location.hash="/profile/?id="+result[0].iduser;
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = "Could not connect to server";
            errorToast.show();
          });
        },
        editArticle : function(that, datos){
          doAjax({
            type: 'POST',
            url: 'routes_article/editarticle',
            data: datos
          },function(result) {
            this.setAttribute('htitle', result[0].title);
            this.setAttribute('content', result[0].content);
            this.setAttribute('date', result[0].date);
            this.setAttribute('bgimg', result[0].bgimg);
            this.setAttribute('owner', result[0].iduser);
            this.setAttribute('idart', result[0]._id);
            this.setAttribute('coments', result[0].coments);
          }.bind(that),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = "Could not connect to server";
            errorToast.show();
          });
        },
        setUser : function(id, datos){
          doAjax({
            type: 'PUT',
            url: 'routes_user/user/'+id,
            data: datos
          },function(result) {
            document.getElementById('user').data(result);
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = xhr.responseText.split(':')[1];
            errorToast.show();
          });
        },
        getArticles : function(id,callback){
          doAjax({
            type: 'GET',
            url: 'routes_article/article/'+id,
          },function(result) {
            callback(result);
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = 'Error could not load';
            errorToast.show();
            callback(false);
          });
        },
        getAllArticles : function(skip, callback){
          doAjax({
            type: 'GET',
            url: 'routes_article/articles/'+skip,
          },function(result) {
            if(result[0] == null){
              callback(result, 'fin');
            }else{
              callback(result);
            }
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = "Could not connect to server";
            errorToast.show();
          });
        },
        deleteArticles : function(id,callback){
          doAjax({
            type: 'DELETE',
            url: 'routes_article/article/'+id,
          },function(result) {
            callback(result);
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            //puesto que no se que pasa xq no consigue ajax identificar que la respuesta ha sido de estado 200 como "buena" la hacemos a mano...
            xhr.status === 200 ? errorToast.text = 'The Article was succesfully deleted': errorToast.text = 'Error, could not delete this article, refresh the page and try it later.';
            errorToast.show();
            callback(false);
          });
        },
        verifyUsername : function(datos, that, callback){
          var data={
            username: datos
          };
          doAjax({
            type: 'GET',
            url: 'routes_user/verifyUsername',
            data: data
          },function(result) {
            callback(result, that);
          }.bind(this),
            function(xhr, err, desc){
              callback(false, that);
            }
          );
        },
        verifyEmail : function(datos, that, callback){
          var data={
            email: datos
          };
          doAjax({
            type: 'GET',
            url: 'routes_user/verifyEmail',
            data: data
          },function(result) {
            callback(result, that);
          }.bind(this),
            function(xhr, err, desc){
              callback(false, that);
            });
        },
        showTopics: function(datos, callback) {
          doAjax({
            type: 'GET',
            url: 'routes_topic/topic?letter='+datos,
          },function(result) {
            console.log(result);
            callback(result);
          }.bind(this),
          function(xhr, err, desc){
            var errorToast = document.querySelector('#errorToast');
            errorToast.text = 'Error could not load topics';
            errorToast.show();
            callback(false);
          });
        }
      });
    }());

    // Para la PAgina de configuracion, cuando meta el usuario lo que sea sobre sus datos
    // var usuarioexistente = document.getElementById('user');
    // var id= usuariocreado.datos._id;
    // var datos={
    //   username: this.$.paper_input.value,
    //   name:"Alex",
    //   mail: this.$.paper_input1.value
    // }
    // ajaxhandler.setUser(id, JSON.stringify(datos));
  </script>
</polymer-element>
