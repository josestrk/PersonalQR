<link rel="import" href="../core-ajax-handler.html">
<link rel="import" href="../core-artc/core-artc.html">
<link rel="import" href="../../bower_components/core-scroll-threshold/core-scroll-threshold.html">
<link rel="import" href="../../bower_components/core-signals/core-signals.html">


<polymer-element name="core-list">

  <template>
    <style>
      #list{
            width: 80%;
            margin: 20px auto;
            height: 500px;
      }
      #scroller {
        overflow: auto;
        margin-top: 4px;
      }
      @media(max-width:721px){
          #list{
            width: 95%;
          }
      }
    </style>
    <core-ajax-handler id="ajaxhandler"></core-ajax-handler>
    <core-signals on-core-signal-sender-list="{{createList}}"></core-signals>
    <core-scroll-threshold id="threshold" scrollTarget="{{$.scroller}}" lowerThreshold="50" on-lower-trigger="{{loadMore}}" fit></core-scroll-threshold>
    <div id="scroller" fit>
      <div id="list"></div>
     <div hidden?="{{!$.threshold.lowerTriggered}}"></div>
    </div>
  </template>

  <script>
    (function () {
      function createPage(item) {
        var section = document.createElement('core-artc');
        section.setAttribute('layout', '');
        section.setAttribute('vertical', '');
        section.setAttribute('title', item.title);
        section.setAttribute('content', item.content);
        section.setAttribute('date', item.date);
        section.setAttribute('bgimg', item.bgimg);
        section.setAttribute('owner', item.iduser);
        section.setAttribute('idart', item._id);
        section.setAttribute('coments', item.coments);
        return section;
      }
      Polymer({
        createList: function(rescue){
          var that=this;
          var sk= this.skip;
          var list=rescue.detail;
          list.forEach(function (item) {
            that.$.list.appendChild(createPage(item));
          }.bind(that));
          this.skip++;
        },
        loadMore: function(){
          var that=this;
          var ajaxhandler = this.$.ajaxhandler;
          var sk= this.skip;
          if(this.status!=='fin'){
            this.fire("loader");
            setTimeout(function() {
                ajaxhandler.getAllArticles(sk,function (result, status){
                  if(status==='fin'){
                    that.status='fin';
                  }
                  if(result){
                    result.forEach(function (item) {
                      that.$.list.appendChild(createPage(item));
                    }.bind(that));
                  }
                }.bind(that));
            },500);
          }
          this.skip++;

         this.$.threshold.clearLower();
        },
        skip: 0
      });
    })();
  </script>

</polymer-element>
