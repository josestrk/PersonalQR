<link rel="import" href="../core/id-card/id-card.html">
<link rel="import" href="../core/core-ajax-handler.html">

<link rel="import" href="../lib/webcomponent/github-card.html">
<link rel="import" href="../bower_components/instagram-card/dist/instagram-card.html">

<polymer-element name="person-card">
  <template>
    <style>
        .card{
            background: #666;
            color: white;
            margin: auto;
            padding: 10px;
            box-shadow: rgba(0, 0, 0, 0.0980392) 0px 2px 4px, rgba(0, 0, 0, 0.0980392) 0px 0px 3px;
        }
        id-card{
            width: 100%;
        }
        #follow{
          -webkit-box-shadow: 8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          -moz-box-shadow:    8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          box-shadow:         8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          padding: 11px;
          background: #4592BD;
        }
        #unfollow{
          -webkit-box-shadow: 8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          -moz-box-shadow:    8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          box-shadow:         8px 7px 18px 0px rgba(50, 54, 50, 0.6);
          padding: 11px;
          background: #4532BD;
        }
        #panel{
            width:100%;
            height:50%;
            margin:auto;
        }
    </style>
    <core-ajax-handler id="ajaxhandler"></core-ajax-handler>

    <main-menu imenu="" iduser="{{userid}}">
        <div class="title" id="name"></div>
        <div class="container">
            <core-card  class="card" layout vertical center center-justified>
                <id-card layout vertical center center-justified>
                    <img class="img" id='photo' src="{{ this.photoUrl }}"/>
                    <user-name id="name"></user-name>
                    <user-account id="email"></user-account>
                    <span id="followers"> </span><span id="following"> </span>
                </id-card>
                  <core-icon-button id="follow" icon="social:person-add" on-click="{{follow}}"></core-icon-button>
                  <core-icon-button id="unfollow" icon="delete" on-click="{{unfollow}}"></core-icon-button>
            </core-card>
            <core-card class="rrss">
                <div id="panel">
                    <github-card user="Josestrk" class="card"></github-card>
                    <main-index></main-index>
                    <!-- <instagram-card clientId='josestrk'></instagram-card> -->

                </div>
            </core-card>
        </div>

    </main-menu>
  </template>
  <script>
    (function () {

        function doAjax(options, success, error) {
          options.dataType = options.dataType || 'json';
          options.contentType = options.contentType || 'application/json; charset=UTF-8';
          options.success = success;

          options.beforeSend = function(xhr) {
            xhr.setRequestHeader('Authorization', 'Bearer ' + localStorage.token);
          };

          $.ajax(options);
        }

        Polymer({
            domReady: function(){
                this.rellenarProfile();
            },
            setfollow : function (res) {
              res.followers.indexOf(document.getElementById('user').datos._id) !== -1 ? this.$.follow.style.display = 'none' : this.$.unfollow.style.display = 'none';
            },
            rellenarProfile : function (){
              var id = document.URL.split('/').reverse()[0].split('=').reverse()[0] || "500" ;
              if (id !== '500') {
              doAjax({
                    type: 'GET',
                    url: 'routes_user/user/'+id,
                },function( result ) {
                    this.$.photo.src = result.picture ? result.picture : "../img/avatar.svg" ;
                    this.$.name.innerHTML = result.name ? result.name : "Anonimous" ;
                    this.$.email.innerHTML = result.email ? result.email : "" ;
                    this.$.followers.innerHTML = result.followers ? result.followers.length : "0" ;
                    this.$.following.innerHTML = result.following ? result.following.length : "0" ;
                    if (document.getElementById('user').datos._id !== result._id){
                      this.setfollow(result);
                    }else{
                      this.$.unfollow.style.display = 'none';
                      this.$.follow.style.display = 'none';
                    }
                }.bind(this),
                function(xhr, err, desc){
                    var errorToast = document.querySelector('#errorToast');
                    errorToast.text = 'The user '+id+' do not exist';
                    errorToast.show();
                });
              }else{
                var errorToast = document.querySelector('#errorToast');
                errorToast.text = 'Error retrieving data, verify your code';
                errorToast.show();
              }
            },
            articlesProfile:function(){
                document.querySelector('app-router').go('/wall/'+id);
            },
            socialProfile: function(){

            },
            changebutton: function () {
              if(this.$.follow.style.display == 'none'){
                 this.$.follow.style.display = 'inherit';
                 this.$.unfollow.style.display = 'none';
               }else{
                if(this.$.unfollow.style.display == 'none'){
                  this.$.unfollow.style.display = 'inherit';
                  this.$.follow.style.display = 'none' ;
                }
               }
            },
            follow : function () {
              var id = document.URL.split('/').reverse()[0].split('=').reverse()[0] || "500" ;
              var dato = JSON.stringify({toFollow: id});
              if (id !== '500') {
              doAjax({
                    type: 'POST',
                    url: 'routes_user/follow/',
                    data: dato
                },function( result ) {
                  this.$.followers.innerHTML = parseInt(this.$.followers.innerHTML)+1;
                  this.changebutton();
                }.bind(this),
                function(xhr, err, desc){
                    var errorToast = document.querySelector('#errorToast');
                    errorToast.text = 'You are not logged.';
                    errorToast.show();
                });
              }else{
                var errorToast = document.querySelector('#errorToast');
                errorToast.text = 'Error, not a valid id found.';
                errorToast.show();
              }
            },
            unfollow : function () {
              var id = document.URL.split('/').reverse()[0].split('=').reverse()[0] || "500" ;
              var dato = JSON.stringify({toUnFollow: id});
              if (id !== '500') {
              doAjax({
                    type: 'POST',
                    url: 'routes_user/unfollow/',
                    data: dato
                },function( result ) {
                  this.$.followers.innerHTML = parseInt(this.$.followers.innerHTML)-1;
                  this.changebutton();
                }.bind(this),
                function(xhr, err, desc){
                    var errorToast = document.querySelector('#errorToast');
                    errorToast.text = 'You are not logged.';
                    errorToast.show();
                });
              }else{
                var errorToast = document.querySelector('#errorToast');
                errorToast.text = 'Error, not a valid id found.';
                errorToast.show();
              }
            }
        });
    })();
  </script>
</polymer-element>
